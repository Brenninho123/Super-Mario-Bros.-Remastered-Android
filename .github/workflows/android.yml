name: ğŸ® Build Super Mario Bros. Android

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ” Analisar estrutura do projeto
      id: analyze
      run: |
        echo "=== ESTRUTURA DO PROJETO ==="
        find . -type f -name "*.gradle*" -o -name "*.kts" -o -name "*.apk" -o -name "AndroidManifest.xml" | head -30
        echo ""
        
        # Verifica tipo de projeto
        if [ -f "app/build.gradle" ] || [ -f "app/build.gradle.kts" ]; then
          echo "TIPO=ANDROID_APP" >> $GITHUB_OUTPUT
          echo "PROJECT_DIR=app" >> $GITHUB_OUTPUT
        elif [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
          echo "TIPO=ANDROID_ROOT" >> $GITHUB_OUTPUT
          echo "PROJECT_DIR=." >> $GITHUB_OUTPUT
        elif [ -d "Assets" ] && [ -f "ProjectSettings/ProjectSettings.asset" ]; then
          echo "TIPO=UNITY" >> $GITHUB_OUTPUT
        elif find . -name "*.csproj" | grep -q .; then
          echo "TIPO=DOTNET" >> $GITHUB_OUTPUT
        else
          echo "TIPO=UNKNOWN" >> $GITHUB_OUTPUT
        fi
        
    - name: â˜• Configurar JDK (se for Android)
      if: steps.analyze.outputs.TIPO == 'ANDROID_APP' || steps.analyze.outputs.TIPO == 'ANDROID_ROOT'
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: ğŸ¤– Configurar Android SDK
      if: steps.analyze.outputs.TIPO == 'ANDROID_APP' || steps.analyze.outputs.TIPO == 'ANDROID_ROOT'
      uses: android-actions/setup-android@v3
      
    - name: ğŸ› ï¸ Tentar construir (MÃ©todo Universal)
      id: build-attempt
      run: |
        echo "ğŸ”„ Iniciando tentativa de build..."
        
        # MÃ‰TODO 1: Se tiver gradlew
        if [ -f "./gradlew" ]; then
          echo "ğŸ“¦ MÃ©todo 1: Usando gradlew"
          chmod +x ./gradlew
          
          # Tenta primeiro no diretÃ³rio atual
          ./gradlew tasks 2>&1 | head -20 || true
          
          # Tenta tarefas comuns
          TASKS=("build" "assemble" "assembleDebug" "assembleRelease" "compileDebugSources")
          for task in "${TASKS[@]}"; do
            echo "ğŸ”„ Tentando: ./gradlew $task"
            if timeout 300 ./gradlew $task 2>&1; then
              echo "âœ… SUCESSO com ./gradlew $task"
              echo "BUILD_METHOD=gradlew" >> $GITHUB_OUTPUT
              echo "BUILD_TASK=$task" >> $GITHUB_OUTPUT
              exit 0
            fi
          done
        fi
        
        # MÃ‰TODO 2: Procurar subprojetos Android
        echo "ğŸ” MÃ©todo 2: Procurando projetos Android..."
        ANDROID_PROJECTS=$(find . -name "build.gradle" -o -name "build.gradle.kts" | head -5)
        
        for project in $ANDROID_PROJECTS; do
          PROJECT_DIR=$(dirname "$project")
          echo "ğŸ“ Analisando: $PROJECT_DIR"
          
          cd "$PROJECT_DIR"
          
          if [ -f "gradlew" ]; then
            chmod +x gradlew
            if ./gradlew tasks 2>&1 | grep -q "assemble"; then
              echo "ğŸ—ï¸ Construindo em $PROJECT_DIR..."
              ./gradlew assembleDebug 2>&1 && {
                echo "âœ… SUCESSO em $PROJECT_DIR"
                echo "BUILD_METHOD=gradlew_subproject" >> $GITHUB_OUTPUT
                echo "BUILD_DIR=$PROJECT_DIR" >> $GITHUB_OUTPUT
                exit 0
              }
            fi
          fi
          
          cd - > /dev/null
        done
        
        # MÃ‰TODO 3: Verificar se jÃ¡ tem APK
        echo "ğŸ” MÃ©todo 3: Procurando APKs existentes..."
        EXISTING_APKS=$(find . -name "*.apk" -type f | head -5)
        
        if [ -n "$EXISTING_APKS" ]; then
          echo "âœ… APKs jÃ¡ existentes encontrados:"
          echo "$EXISTING_APKS"
          echo "BUILD_METHOD=apk_exists" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Se chegou aqui, falhou
        echo "âŒ Nenhum mÃ©todo de build funcionou"
        echo "BUILD_METHOD=failed" >> $GITHUB_OUTPUT
        exit 1
        
    - name: ğŸ“¦ Coletar resultados da build
      if: steps.build-attempt.outputs.BUILD_METHOD != 'failed'
      run: |
        echo "ğŸ“Š Resultado do build:"
        echo "MÃ©todo: ${{ steps.build-attempt.outputs.BUILD_METHOD }}"
        echo "Tarefa: ${{ steps.build-attempt.outputs.BUILD_TASK || 'N/A' }}"
        echo "DiretÃ³rio: ${{ steps.build-attempt.outputs.BUILD_DIR || '.' }}"
        
        echo ""
        echo "ğŸ” Procurando APKs..."
        find . -name "*.apk" -type f 2>/dev/null | while read apk; do
          echo "ğŸ“± APK encontrado: $apk"
          ls -lh "$apk"
        done || echo "Nenhum APK encontrado"
        
    - name: ğŸ“¤ Upload de APKs
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: super-mario-apks
        path: |
          **/*.apk
          **/build/outputs/**/*.apk
          **/build/**/*.apk
        retention-days: 30
        if-no-files-found: warn
        
    - name: ğŸ“‹ Upload de logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          **/build/reports/
          **/build/outputs/logs/
          **/*.log
        retention-days: 7
        if-no-files-found: ignore

  # Job para criar release automÃ¡tica
  release:
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: ğŸ“¥ Baixar APKs
      uses: actions/download-artifact@v4
      with:
        name: super-mario-apks
        
    - name: ğŸ·ï¸ Criar Release
      uses: softprops/action-gh-release@v1
      with:
        files: "*.apk"
        tag_name: "build-${{ github.run_number }}"
        name: "Build #${{ github.run_number }}"
        body: |
          Build automÃ¡tica do Super Mario Bros. Remastered
          
          - Commit: ${{ github.sha }}
          - Data: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - ExecuÃ§Ã£o: #${{ github.run_number }}
          
          InstruÃ§Ãµes:
          1. Baixe o APK
          2. Habilite "Fontes desconhecidas" no Android
          3. Instale o aplicativo
        draft: false
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}