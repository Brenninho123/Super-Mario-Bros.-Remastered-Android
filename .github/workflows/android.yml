name: Android Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Permite execuÃ§Ã£o manual

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    # PASSO DE DIAGNÃ“STICO (opcional, remove depois)
    - name: Debug project structure
      run: |
        echo "=== ESTRUTURA DO PROJETO ==="
        ls -la
        echo ""
        echo "=== ARQUIVOS GRADLE ==="
        find . -name "*.gradle*" -o -name "*.kts" 2>/dev/null | head -20 || true
        echo ""
        echo "=== PASTA ANDROID ==="
        find . -name "AndroidManifest.xml" -o -name "build.gradle" 2>/dev/null | head -10 || true
        
    # CONSTRUÃ‡ÃƒO FLEXÃVEL (funciona com ou sem gradlew)
    - name: Build Android project
      run: |
        # MÃ©todo 1: Se existir gradlew
        if [ -f "./gradlew" ]; then
          echo "âœ… Encontrado gradlew, usando wrapper..."
          chmod +x ./gradlew
          ./gradlew assembleDebug || ./gradlew build
          
        # MÃ©todo 2: Se encontrar build.gradle mas nÃ£o gradlew  
        elif [ -f "build.gradle" ] || [ -f "build.gradle.kts" ] || [ $(find . -name "*.gradle*" -o -name "*.kts" 2>/dev/null | wc -l) -gt 0 ]; then
          echo "ðŸ“¦ Projeto Gradle detectado (sem wrapper)..."
          echo "Instalando Gradle..."
          
          # Instala Gradle
          wget https://services.gradle.org/distributions/gradle-8.5-bin.zip
          sudo unzip -d /opt/gradle gradle-8.5-bin.zip
          export PATH=$PATH:/opt/gradle/gradle-8.5/bin
          
          # Tenta construir
          if [ -f "build.gradle" ]; then
            gradle assembleDebug || gradle build
          else
            # Procura o primeiro build.gradle
            GRADLE_FILE=$(find . -name "build.gradle" -o -name "build.gradle.kts" | head -1)
            echo "Usando arquivo: $GRADLE_FILE"
            cd $(dirname "$GRADLE_FILE")
            gradle assembleDebug || gradle build
          fi
          
        # MÃ©todo 3: Para projetos Unity (se for o caso)
        elif [ -f "Assets" ] || [ -d "Assets" ]; then
          echo "ðŸŽ® PossÃ­vel projeto Unity detectado..."
          echo "âš ï¸  Configure build especÃ­fica para Unity"
          
        else
          echo "âŒ Nenhum projeto de build detectado!"
          echo "ConteÃºdo da pasta:"
          ls -la
          exit 1
        fi
        
    # ENCONTRA E FAZ UPLOAD DO APK
    - name: Find and upload APK
      if: success()
      run: |
        echo "ðŸ” Procurando APKs..."
        find . -name "*.apk" 2>/dev/null | while read apk; do
          echo "Encontrado: $apk"
        done
        
        APK_COUNT=$(find . -name "*.apk" 2>/dev/null | wc -l)
        if [ $APK_COUNT -eq 0 ]; then
          echo "âš ï¸  Nenhum APK encontrado!"
          # Procura em locais comuns do Android
          find . -path "*/build/outputs/apk/*" -name "*.apk" 2>/dev/null | while read apk; do
            echo "APK em local comum: $apk"
          done
        else
          echo "âœ… Encontrados $APK_COUNT APK(s)"
        fi
        
    - name: Upload APK artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: |
          **/*.apk
          **/build/outputs/apk/**/*.apk
        retention-days: 7
        
    # LIMPEZA (opcional)
    - name: Clean up
      if: always()
      run: |
        echo "ðŸ§¹ Limpeza concluÃ­da"
        df -h