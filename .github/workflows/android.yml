name: ğŸ® Super Mario Bros. Android Build

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # ExecuÃ§Ã£o manual

env:
  GRADLE_VERSION: '8.5'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: â˜• Configurar JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: ğŸ¤– Configurar Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 33
        build-tools-version: '33.0.2'
        ndk-version: '25.2.9519653'
        
    - name: ğŸ” Verificar estrutura do projeto
      id: project-struct
      run: |
        echo "Estrutura encontrada:"
        ls -la
        echo ""
        # Verifica se Ã© projeto Gradle
        if find . -name "*.gradle*" -o -name "*.kts" | grep -q .; then
          echo "GRADLE_PROJECT=true" >> $GITHUB_OUTPUT
        else
          echo "GRADLE_PROJECT=false" >> $GITHUB_OUTPUT
        fi
        
    - name: ğŸ“¦ Configurar Gradle (se necessÃ¡rio)
      if: steps.project-struct.outputs.GRADLE_PROJECT == 'true'
      run: |
        # Verifica se gradlew existe
        if [ ! -f "./gradlew" ]; then
          echo "ğŸ“¥ Instalando Gradle ${{ env.GRADLE_VERSION }}..."
          wget -q https://services.gradle.org/distributions/gradle-${{ env.GRADLE_VERSION }}-bin.zip
          sudo unzip -q -d /opt/gradle gradle-${{ env.GRADLE_VERSION }}-bin.zip
          echo "/opt/gradle/gradle-${{ env.GRADLE_VERSION }}/bin" >> $GITHUB_PATH
        else
          echo "âœ… gradlew encontrado"
          chmod +x ./gradlew
        fi
        
    - name: ğŸ—ï¸ Construir projeto
      id: build
      run: |
        echo "Iniciando construÃ§Ã£o..."
        
        # Tenta com gradlew primeiro
        if [ -f "./gradlew" ]; then
          echo "ğŸ”§ Usando ./gradlew..."
          ./gradlew assembleDebug --no-daemon --stacktrace
          
        # Fallback para gradle instalado
        elif which gradle > /dev/null; then
          echo "ğŸ”§ Usando gradle do sistema..."
          
          # Encontra o diretÃ³rio principal do projeto Android
          if [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
            gradle assembleDebug --no-daemon --stacktrace
          else
            # Procura subprojetos
            PROJECT_DIR=$(find . -name "build.gradle" -o -name "build.gradle.kts" | head -1 | xargs dirname)
            if [ -n "$PROJECT_DIR" ]; then
              echo "ğŸ“ Entrando em $PROJECT_DIR"
              cd "$PROJECT_DIR"
              gradle assembleDebug --no-daemon --stacktrace
            else
              echo "âŒ Nenhum arquivo build.gradle encontrado"
              exit 1
            fi
          fi
          
        else
          echo "âŒ Nenhuma ferramenta de build disponÃ­vel"
          exit 1
        fi
        
    - name: ğŸ” Localizar APKs gerados
      id: find-apks
      if: success()
      run: |
        echo "Procurando APKs..."
        
        # Procura em locais padrÃ£o do Android
        APK_PATHS=()
        
        # 1. Procura recursivamente
        while IFS= read -r apk; do
          APK_PATHS+=("$apk")
          echo "ğŸ” Encontrado: $apk"
        done < <(find . -name "*.apk" -type f 2>/dev/null)
        
        # 2. Se nÃ£o encontrou, procura em paths comuns
        if [ ${#APK_PATHS[@]} -eq 0 ]; then
          COMMON_PATHS=(
            "*/build/outputs/apk/**/*.apk"
            "app/build/outputs/apk/**/*.apk"
            "*/build/**/*.apk"
          )
          
          for pattern in "${COMMON_PATHS[@]}"; do
            for apk in $pattern; do
              if [ -f "$apk" ]; then
                APK_PATHS+=("$apk")
                echo "ğŸ” Encontrado (padrÃ£o): $apk"
              fi
            done
          done
        fi
        
        # Exporta paths para prÃ³ximo passo
        if [ ${#APK_PATHS[@]} -gt 0 ]; then
          echo "APK_COUNT=${#APK_PATHS[@]}" >> $GITHUB_OUTPUT
          echo "APK_PATHS=${APK_PATHS[*]}" >> $GITHUB_OUTPUT
        else
          echo "APK_COUNT=0" >> $GITHUB_OUTPUT
          echo "âš ï¸ Nenhum APK encontrado!"
        fi
        
    - name: ğŸ“¤ Upload do APK (se encontrado)
      if: steps.find-apks.outputs.APK_COUNT != '0'
      uses: actions/upload-artifact@v4
      with:
        name: super-mario-apk
        path: |
          ${{ steps.find-apks.outputs.APK_PATHS }}
        retention-days: 30
        if-no-files-found: error
        
    - name: ğŸ“Š Upload do relatÃ³rio de build
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-reports
        path: |
          **/build/reports/
          **/build/outputs/logs/
        retention-days: 7
        if-no-files-found: ignore
        
    - name: ğŸ§ª Executar testes (opcional)
      if: success()
      run: |
        if [ -f "./gradlew" ]; then
          ./gradlew test --no-daemon || echo "âš ï¸ Testes falharam, continuando..."
        elif which gradle > /dev/null; then
          gradle test --no-daemon || echo "âš ï¸ Testes falharam, continuando..."
        fi

  # Job adicional para criar Release
  release:
    name: ğŸš€ Criar Release
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Baixar APK do build
      uses: actions/download-artifact@v4
      with:
        name: super-mario-apk
        pattern: '*.apk'
        
    - name: ğŸ·ï¸ Criar Tag e Release
      uses: softprops/action-gh-release@v1
      with:
        files: "*.apk"
        tag_name: "v1.0.${{ github.run_number }}"
        name: "Super Mario Bros. v1.0.${{ github.run_number }}"
        body: |
          ## ğŸ® Super Mario Bros. Remastered - Android
          
          Build automÃ¡tica #${{ github.run_number }}
          
          ### ğŸ“‹ Detalhes:
          - Commit: ${{ github.sha }}
          - Data: ${{ github.event.head_commit.timestamp }}
          - Branch: ${{ github.ref_name }}
          
          ### ğŸ“± InstalaÃ§Ã£o:
          1. Baixe o APK acima
          2. Habilite "Fontes desconhecidas" no Android
          3. Instale e divirta-se!
          
          âš ï¸ **AtenÃ§Ã£o**: Este Ã© um projeto educacional/fan-made.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}